--------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  V:\STATISTICS\NON STUDY FOLDER\Academic Research\Eudract Tool\testing\stata\output\testing.
> log
  log type:  text
 opened on:  15 Jan 2020, 14:33:45

. do "C:\Users\sjb277\AppData\Local\Temp\13\STD00000000.tmp"

. * check if the termsoc definition works with soc_term as character
. *http://wlm.userweb.mwn.de/Stata/wstataddm.htm
. clear

. global freq_threshold 0

. cd  "V:\STATISTICS\NON STUDY FOLDER\Academic Research\Eudract Tool\testing\stata\Stata Eudract Tools"
V:\STATISTICS\NON STUDY FOLDER\Academic Research\Eudract Tool\testing\stata\Stata Eudract Tools

. global datafile "..\..\data\events.csv"

. global soc_index soc_term

. input exposed excessdeaths

       exposed  excessd~s
  1. 20 2
  2. 22 6
  3. 18 4
  4. end

. save EXPOSED, replace
(note: file EXPOSED.dta not found)
file EXPOSED.dta saved

. 
. import delimited using "soc_code.csv", varnames(1) clear
(3 vars, 27 obs)

. rename ${soc_index} soc

. gen eutctid2=string(eutctid,"%14.0g")

. keep soc eutctid2

. rename eutctid2 eutctid

. save soc_code, replace
file soc_code.dta saved

. 
. import delimited using ${datafile} , varnames(1) clear
(7 vars, 1638 obs)

. save raw, replace
file raw.dta saved

. 
. 
. 
. 
. 
. gen nonserious=1-serious

. collapse (max) serious nonserious fatal, by(subjid group)

. collapse (sum) serious nonserious fatal, by(group) 

. 
. 
. sort group

. merge 1:1 _n using EXPOSED, nogenerate

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                 3  
    -----------------------------------------

. gen deathsAllCauses=fatal+excessdeaths

. recast int serious nonserious fatal deathsAllCauses exposed

. drop excessdeaths

. 
. la var group "title"

. la var fatal "deathsResultingFromAdverseEvents"

. la var serious "subjectsAffectedBySeriousAdverseEvents"

. la var nonserious "subjectsAffectedByNonSeriousAdverseEvents"

. la var exposed "subjectsExposed"

. la var deathsAllCauses "deathsAllCauses"

. 
. save GROUPS, replace
file GROUPS.dta saved

. xmlsave "../output/group", legible replace
file ../output/group.xml saved

. 
. 
. * non-serious
. 
. 
. clear

. 
. use raw if serious==0

. capture confirm numeric variable soc

. if _rc==0 {
.         gen termsoc = term + string(soc,"%12.0g")
. } 

. else {
.         gen termsoc = term + soc
. }

. save nonserious, replace
file nonserious.dta saved

. 
. *create all combinations of group and termsoc
. sort term soc termsoc

. duplicates drop term soc termsoc, force

Duplicates in terms of term soc termsoc

(827 observations deleted)

. keep term soc termsoc

. cross using GROUPS

. keep term soc termsoc group

. save ALLCOMBS, replace
(note: file ALLCOMBS.dta not found)
file ALLCOMBS.dta saved

. 
. use nonserious

. contract group termsoc, freq(occurrences)

. save OCCURRENCES, replace
(note: file OCCURRENCES.dta not found)
file OCCURRENCES.dta saved

. 
. use nonserious

. duplicates drop termsoc group subjid , force

Duplicates in terms of termsoc group subjid

(413 observations deleted)

. contract group termsoc, freq(subjectsAffected)

. save SUBJECTS, replace
(note: file SUBJECTS.dta not found)
file SUBJECTS.dta saved

. 
. merge 1:1  group termsoc using OCCURRENCES, nogenerate

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                78  
    -----------------------------------------

. save NONSERIOUS, replace
file NONSERIOUS.dta saved

. clear

. use ALLCOMBS

. merge 1:1 termsoc group using NONSERIOUS, keep(match master)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                78  (_merge==3)
    -----------------------------------------

. replace occurrences=0 if _merge==1
(0 real changes made)

. replace subjectsAffected=0 if _merge==1
(0 real changes made)

. drop _merge

. save NONSERIOUS, replace
file NONSERIOUS.dta saved

. 
. * FILTER by rate
. merge m:1 group using GROUPS

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                78  (_merge==3)
    -----------------------------------------

. gen rate=subjectsAffected/exposed *100

. collapse (max) rate, by(termsoc)

. drop if rate < $freq_threshold
(0 observations deleted)

. keep termsoc

. merge 1:m termsoc using NONSERIOUS, nogenerate keep(match master)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                78  
    -----------------------------------------

. sort termsoc group

. drop termsoc

. 
. la var group "groupTitle"

. la var subjectsAffected "subjectsAffected"

. la var occurrences "occurrences"

. la var term "term"

. 
. 
. 
. save NONSERIOUS, replace
file NONSERIOUS.dta saved

. 
. clear

. use NONSERIOUS

. merge m:1 soc using soc_code

    Result                           # of obs.
    -----------------------------------------
    not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    matched                                78  (_merge==3)
    -----------------------------------------

. drop if _merge==2
(1 observation deleted)

. drop _merge soc

. la var eutctid "eutctId"

. save NONSERIOUS, replace
file NONSERIOUS.dta saved

. 
. 
. xmlsave "../output/non_serious", legible replace
file ../output/non_serious.xml saved

. 
. * serious
. clear

. use raw if serious==1

. capture confirm numeric variable soc

. if _rc==0 {
.         gen termsoc = term + string(soc,"%12.0g")
. } 

. else {
.         gen termsoc = term + soc
. }

. gen relatedDeath=fatal*related

. save serious, replace
file serious.dta saved

. 
. duplicates drop term soc termsoc, force

Duplicates in terms of term soc termsoc

(759 observations deleted)

. keep term soc termsoc

. cross using GROUPS

. keep term soc termsoc group

. save ALLCOMBS, replace
file ALLCOMBS.dta saved

. 
. use serious

. contract group termsoc, freq(occurrences)

. save OCCURRENCES, replace
file OCCURRENCES.dta saved

. 
. use serious

. duplicates drop termsoc group subjid, force

Duplicates in terms of termsoc group subjid

(368 observations deleted)

. contract group termsoc, freq(subjectsAffected)

. save SUBJECTS, replace
file SUBJECTS.dta saved

. 
. use serious

. collapse(sum) related fatal relatedDeath, by(group termsoc)

. recast int related fatal relatedDeath

. save RELATEDFATAL, replace
(note: file RELATEDFATAL.dta not found)
file RELATEDFATAL.dta saved

. 
. use OCCURRENCES

. merge 1:1 group termsoc using SUBJECTS, nogenerate

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                77  
    -----------------------------------------

. merge m:1 group termsoc using RELATEDFATAL, nogenerate keep(match master)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                77  
    -----------------------------------------

. save SERIOUS, replace
file SERIOUS.dta saved

. 
. clear

. use ALLCOMBS

. merge 1:1 termsoc group using SERIOUS, keep(match master)

    Result                           # of obs.
    -----------------------------------------
    not matched                             1
        from master                         1  (_merge==1)
        from using                          0  (_merge==2)

    matched                                77  (_merge==3)
    -----------------------------------------

. replace occurrences=0 if _merge==1
(1 real change made)

. replace subjectsAffected=0 if _merge==1
(1 real change made)

. replace related=0 if _merge==1
(1 real change made)

. replace fatal=0 if _merge==1
(1 real change made)

. replace relatedDeath=0 if _merge==1
(1 real change made)

. drop _merge termsoc

. 
. la var group "groupTitle"

. la var subjectsAffected "subjectsAffected"

. la var occurrences "occurrences"

. la var term "term"

. la var related "occurrencesCausallyRelatedToTreatment"

. la var fatal "deaths"

. la var relatedDeath     "deathsCausallyRelatedToTreatment"

. 
. 
. save SERIOUS, replace
file SERIOUS.dta saved

. 
. clear

. use SERIOUS

. merge m:1 soc using soc_code

    Result                           # of obs.
    -----------------------------------------
    not matched                             1
        from master                         0  (_merge==1)
        from using                          1  (_merge==2)

    matched                                78  (_merge==3)
    -----------------------------------------

. drop if _merge==2
(1 observation deleted)

. drop _merge soc

. la var eutctid "eutctId"

. save SERIOUS, replace
file SERIOUS.dta saved

. 
. 
. xmlsave "../output/serious", legible replace
file ../output/serious.xml saved

. 
. rm ALLCOMBS.dta 

. rm OCCURRENCES.dta

. rm SUBJECTS.dta 

. rm RELATEDFATAL.dta

. rm EXPOSED.dta

. 
. 
. ! msxsl.exe stata_statsfiles.xml stata_combine.xslt -o ../output/simple.xml

. 
. ! msxsl.exe ../output/simple.xml simpleToEudraCT.xslt -o ../output/table_eudract.xml

. 
. display "Please email cctu@addenbrookes.nhs.uk to tell us if you have successfully uploaded a study to
>  EudraCT.  This is to allow us to measure the impact of this tool."
Please email cctu@addenbrookes.nhs.uk to tell us if you have successfully uploaded a study to EudraCT.  
> This is to allow us to measure the impact of this tool.

. 
end of do-file

. log close
      name:  <unnamed>
       log:  V:\STATISTICS\NON STUDY FOLDER\Academic Research\Eudract Tool\testing\stata\output\testing.
> log
  log type:  text
 closed on:  15 Jan 2020, 14:34:38
--------------------------------------------------------------------------------------------------------

1    /* clear log and output */
2    dm 'log; clear; output; clear;';
3
4    /*UPDATE to Study Directory*/
5    %let dir=P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK;
6
7    /* Defining program name */
8    %let progname=XML_creator;
9
10   /*
11   _____________________________________________________________________________________________
11 ! __________________
12
13       Filename                :  XML_creator_V1.0.sas
14
15       Date created            :  25/01/2017
16
17       Last amended            :
18
19       Trial                   :
20
21       Analysis                :
22
23       Purpose Of Program      :  To process a standard dataset to output to xml for upload to
23 ! Eudract system
24
25       Directory               :  &dir directory above
26
27       Statistician            :  Andrew Hall
28
29       SAS version             :  9.4
30
31       Datasets created        :
32
33       Output files            :  EudractUpload.xml
34
35       Reviewed by             :  Kara-Louise Royle
36
37       Date reviewed           :  02/08/2017
38
39
40       Amended by              :
41   _____________________________________________________________________________________________
41 ! __________________
42
43   */
44
45
46   /**************/
47   /* Data steps */
48   /**************/
49
50   title "Eudract XML creator";
51   footnote;
52
53   /* UPDATE the library to be where the SOC formats library is */
54   libname library "&dir.\SASformats";
NOTE: Libref LIBRARY was successfully assigned as follows:
      Engine:        V9
      Physical Name:
      P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\SASformats
55
56   /* UPDATE the folder name to be where study-specific managed data are stored */
57   libname m "&dir.\SASdata";
NOTE: Libref M was successfully assigned as follows:
      Engine:        V9
      Physical Name:
      P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\SASdata
58
59   %macro open1(dataset);
60    data &dataset;
61     set m.&dataset;
62   run;
63   %mend open1;
64
65   %open1(EudractGrps);

NOTE: There were 2 observations read from the data set M.EUDRACTGRPS.
NOTE: The data set WORK.EUDRACTGRPS has 2 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.02 seconds
      cpu time            0.03 seconds


66   %open1(EudractAE);

NOTE: There were 20 observations read from the data set M.EUDRACTAE.
NOTE: The data set WORK.EUDRACTAE has 20 observations and 7 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds


67   %open1(EudractSAE);

NOTE: There were 20 observations read from the data set M.EUDRACTSAE.
NOTE: The data set WORK.EUDRACTSAE has 20 observations and 10 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds


68
69
70   /***********************************************************************/
71   /* Merge numbers exposed from groups dataset and add SOC EUTCT numbers */
72   /***********************************************************************/
73
74   /*AEs*/
75   proc sql;
76       create table AEs as
77       select a.*, b.patn, input('VersionNumber',version.) as version, input(a.soc,soc.) as
77 ! eutctId
78       from EudractAE as a left join EudractGrps as b on a.idn=b.idn
79       order by a.term, a.idn;
NOTE: Table WORK.AES created, with 20 rows and 10 columns.

80   quit;
NOTE: PROCEDURE SQL used (Total process time):
      real time           0.05 seconds
      cpu time            0.04 seconds


81
82   /*SAEs*/
83   proc sql;
84       create table SAEs as
85       select a.*, b.patn, input('VersionNumber',version.) as version, input(a.soc,soc.) as
85 ! eutctId
86       from EudractSAE as a left join EudractGrps as b on a.idn=b.idn
87       order by a.term, a.idn;
NOTE: Table WORK.SAES created, with 20 rows and 13 columns.

88   quit;
NOTE: PROCEDURE SQL used (Total process time):
      real time           0.02 seconds
      cpu time            0.06 seconds


89
90   /**********************/
91   /* Write the XML file */
92   /**********************/
93
94   /*UPDATE output file*/
95   %let file=&dir.\output\EudractUpload.xml;
96
97
98   /*opening tagset*/
99   data _null_;
100      file "&file";
101
102      /*note no 'MOD' in line above this will create a new file*/
103      put '<aev:adverseEvents
103! xmlns:aev="http://eudract.ema.europa.eu/schema/clinical_trial_result/adverse_events"
103! xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">';
104  run;

NOTE: The file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml" is:

      Filename=P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\Eu
      dractUpload.xml,
      RECFM=V,LRECL=32767,File Size (bytes)=0,
      Last Modified=02 August 2017 14:47:34 o'clock,
      Create Time=02 August 2017 14:47:34 o'clock

NOTE: 1 record was written to the file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml".
      The minimum record length was 158.
      The maximum record length was 158.
NOTE: DATA statement used (Total process time):
      real time           0.02 seconds
      cpu time            0.00 seconds


105
106  /*reporting groups output*/
107  data _null_;
108      file "&file" mod;
109      set EudractGrps end=eof;
110
111      /*opening tagset*/
112      if _n_=1 then
113          put '          <reportingGroups>';
114
115      /*tagset for each observation*/
116      put '           <reportingGroup id="ReportingGroup-' idn +(-1)'">';
117      put '             <title>' id  +(-1)'</title>';
118
119      if not missing(desc) then
120          put '             <description>' desc +(-1)'</description>';
121      put '             <subjectsAffectedByNonSeriousAdverseEvents>' patae
121! +(-1)'</subjectsAffectedByNonSeriousAdverseEvents>';
122      put '             <subjectsAffectedBySeriousAdverseEvents>' patsae
122! +(-1)'</subjectsAffectedBySeriousAdverseEvents>';
123      put '             <subjectsExposed>' patn +(-1)'</subjectsExposed>';
124      put '             <deathsAllCauses>' death +(-1)'</deathsAllCauses>';
125
126      if not missing(deathae) then
127          put '             <deathsResultingFromAdverseEvents>' deathae
127! +(-1)'</deathsResultingFromAdverseEvents>';
128      put '           </reportingGroup>';
129
130      /*closing tagset*/
131      if eof then
132          put '          </reportingGroups>';
133  run;

NOTE: The file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml" is:

      Filename=P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\Eu
      dractUpload.xml,
      RECFM=V,LRECL=32767,File Size (bytes)=160,
      Last Modified=02 August 2017 14:47:34 o'clock,
      Create Time=02 August 2017 14:47:34 o'clock

NOTE: 20 records were written to the file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml".
      The minimum record length was 27.
      The maximum record length was 101.
NOTE: There were 2 observations read from the data set WORK.EUDRACTGRPS.
NOTE: DATA statement used (Total process time):
      real time           0.02 seconds
      cpu time            0.01 seconds


134
135  /*non seriousadverse events or AEs output*/
136  data _null_;
137      file "&file" mod;
138      set AEs end=eof;
139      by term;
140
141      /*opening tagset for all AEs*/
142      if _n_=1 then
143          put '        <nonSeriousAdverseEvents>';
144
145      /*opening tagset for each AE*/
146      if first.term then
147          do;
148              put '            <nonSeriousAdverseEvent>';
149
150              if not missing(desc) then
151                  put '                <description>' desc +(-1)'</description>';
152              put '                <term>' term +(-1)'</term>';
153              put '                <organSystem>';
154              put '                    <eutctId>' eutctId +(-1)'</eutctId>';
155              put '                    <version>' version +(-1)'</version>';
156              put '                </organSystem>';
157              put '                <assessmentMethod>';
158
159              if asstype=1 then
160                  put '                    <value>ADV_EVT_ASSESS_TYPE.systematic</value>';
161              else put '                    <value>ADV_EVT_ASSESS_TYPE.non_systematic</value>';
162              put '                </assessmentMethod>';
163              put '                <dictionaryOverridden>false</dictionaryOverridden>';
164              put '                <values>';
165          end;
166
167      /*tagsets for each arm*/
168      put '                    <value reportingGroupId="ReportingGroup-' idn +(-1)'">';
169      if not missing(occur) then
170      put '                        <occurrences>' occur +(-1)'</occurrences>';
171      put '                        <subjectsAffected>' patsn +(-1)'</subjectsAffected>';
172      put '                        <subjectsExposed>' patn +(-1)'</subjectsExposed>';
173      put '                    </value>';
174
175      /*closing tagset for each AE*/
176      if last.term then
177          do;
178              put '                </values>';
179              put '            </nonSeriousAdverseEvent>';
180          end;
181
182      /*closing tagset for all AEs*/
183      if eof then
184          put '        </nonSeriousAdverseEvents>';
185  run;

NOTE: The file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml" is:

      Filename=P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\Eu
      dractUpload.xml,
      RECFM=V,LRECL=32767,File Size (bytes)=1358,
      Last Modified=02 August 2017 14:47:34 o'clock,
      Create Time=02 August 2017 14:47:34 o'clock

NOTE: 232 records were written to the file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml".
      The minimum record length was 24.
      The maximum record length was 66.
NOTE: There were 20 observations read from the data set WORK.AES.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.01 seconds


186
187
188  /*SAEs output*/
189  data _null_;
190      file "&file" mod;
191      set SAEs end=eof;
192      by term;
193
194      /*opening tagset for all SAEs*/
195      if _n_=1 then
196          put '        <seriousAdverseEvents>';
197
198      /*opening tagset for each SAE*/
199      if first.term then
200          do;
201              put '            <seriousAdverseEvent>';
202
203              if not missing(desc) then
204                  put '                <description>' desc +(-1)'</description>';
205              put '                <term>' term +(-1)'</term>';
206              put '                <organSystem>';
207              put '                    <eutctId>' eutctId +(-1)'</eutctId>';
208              put '                    <version>' version +(-1)'</version>';
209              put '                </organSystem>';
210              put '                <assessmentMethod>';
211
212              if asstype=1 then
213                  put '                    <value>ADV_EVT_ASSESS_TYPE.systematic</value>';
214              else put '                    <value>ADV_EVT_ASSESS_TYPE.non_systematic</value>';
215              put '                </assessmentMethod>';
216              put '                <dictionaryOverridden>false</dictionaryOverridden>';
217              put '                <values>';
218          end;
219
220      /*tagsets for each arm*/
221      put '                    <value reportingGroupId="ReportingGroup-' idn +(-1)'">';
222      put '                        <occurrences>' occur +(-1)'</occurrences>';
223      put '                        <subjectsAffected>' patsn +(-1)'</subjectsAffected>';
224      put '                        <subjectsExposed>' patn +(-1)'</subjectsExposed>';
225      put '                        <occurrencesCausallyRelatedToTreatment>' Occurtrt
225! +(-1)'</occurrencesCausallyRelatedToTreatment>';
226      put '                        <fatalities>';
227      put '                            <deaths>' death +(-1)'</deaths>';
228      put '                            <deathsCausallyRelatedToTreatment>'  deathtrt
228! +(-1)'</deathsCausallyRelatedToTreatment>';
229      put '                        </fatalities>';
230      put '                    </value>';
231
232      /*closing tagset for each SAE*/
233      if last.term then
234          do;
235              put '                </values>';
236              put '            </seriousAdverseEvent>';
237          end;
238
239      /*closing tagset for all AEs*/
240      if eof then
241          put '        </seriousAdverseEvents>';
242  run;

NOTE: The file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml" is:

      Filename=P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\Eu
      dractUpload.xml,
      RECFM=V,LRECL=32767,File Size (bytes)=12474,
      Last Modified=02 August 2017 14:47:34 o'clock,
      Create Time=02 August 2017 14:47:34 o'clock

NOTE: 332 records were written to the file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml".
      The minimum record length was 24.
      The maximum record length was 105.
NOTE: There were 20 observations read from the data set WORK.SAES.
NOTE: DATA statement used (Total process time):
      real time           0.04 seconds
      cpu time            0.03 seconds


243
244
245  /*closing tagset*/
246  DATA _NULL_;
247      FILE "&file" MOD;
248      put '</aev:adverseEvents>';
249  run;

NOTE: The file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml" is:

      Filename=P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\Eu
      dractUpload.xml,
      RECFM=V,LRECL=32767,File Size (bytes)=30172,
      Last Modified=02 August 2017 14:47:34 o'clock,
      Create Time=02 August 2017 14:47:34 o'clock

NOTE: 1 record was written to the file
      "P:\CTRU\Stats\Programming\SAS\Eudract\EudraCT_FormatsValidation\KLR_CHECK\output\EudractUpl
      oad.xml".
      The minimum record length was 20.
      The maximum record length was 20.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds


250
251
252  /*proc datasets nolist memtype=data lib=work kill;*/
253  /*run;*/
254  /*quit;*/
255
256
257  /*output log and output*/
258  dm 'output; file "&dir.\SASout\&progname..lst" replace;';
